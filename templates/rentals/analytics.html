{% extends 'users/base.html' %}
{% load static %}

{% block title %}Analytics - Owner Dashboard{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="page-header">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <h1 class="page-title">
                            <i class="fas fa-chart-line me-2"></i>Analytics Dashboard
                        </h1>
                        <p class="page-subtitle">Track your rental business performance and insights</p>
                    </div>
                    <div class="col-md-6 text-md-end">
                        <div class="date-range-selector">
                            <select class="form-select" id="timeRange">
                                <option value="6m" selected>Last 6 Months</option>
                                <option value="3m">Last 3 Months</option>
                                <option value="1m">Last Month</option>
                                <option value="1y">Last Year</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Sidebar -->
        <div class="col-lg-3 col-md-4">
            {% include 'rentals/partials/owner_sidebar.html' %}
        </div>

        <!-- Main Content -->
        <div class="col-lg-9 col-md-8">
            <!-- Key Metrics -->
            <div class="row mb-4">
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="metric-card revenue">
                        <div class="metric-icon">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                        <div class="metric-content">
                            <h3>${{ total_earnings }}</h3>
                            <p>Total Revenue</p>
                            <span class="metric-change positive">
                                <i class="fas fa-arrow-up"></i> 18.2%
                            </span>
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="metric-card bookings">
                        <div class="metric-icon">
                            <i class="fas fa-calendar-check"></i>
                        </div>
                        <div class="metric-content">
                            <h3>{{ total_bookings }}</h3>
                            <p>Total Bookings</p>
                            <span class="metric-change positive">
                                <i class="fas fa-arrow-up"></i> 12.5%
                            </span>
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="metric-card utilization">
                        <div class="metric-icon">
                            <i class="fas fa-chart-pie"></i>
                        </div>
                        <div class="metric-content">
                            <h3>68%</h3>
                            <p>Car Utilization</p>
                            <span class="metric-change positive">
                                <i class="fas fa-arrow-up"></i> 5.3%
                            </span>
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="metric-card rating">
                        <div class="metric-icon">
                            <i class="fas fa-star"></i>
                        </div>
                        <div class="metric-content">
                            <h3>4.8</h3>
                            <p>Avg. Rating</p>
                            <span class="metric-change neutral">
                                <i class="fas fa-minus"></i> 0.0%
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Row -->
            <div class="row mb-4">
                <!-- Earnings Chart -->
                <div class="col-lg-8 mb-4">
                    <div class="card chart-card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-chart-bar me-2"></i>Monthly Earnings
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="earningsChart" height="250"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Popular Car -->
                <div class="col-lg-4 mb-4">
                    <div class="card popular-car-card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-crown me-2"></i>Most Popular Car
                            </h5>
                        </div>
                        <div class="card-body text-center">
                            {% if popular_car %}
                            <div class="popular-car">
                                <div class="car-image mb-3">
                                    {% if popular_car.image %}
                                    <img src="{{ popular_car.image.url }}" alt="{{ popular_car.make }} {{ popular_car.model }}" class="img-fluid rounded">
                                    {% else %}
                                    <div class="car-image-placeholder large">
                                        <i class="fas fa-car"></i>
                                    </div>
                                    {% endif %}
                                </div>
                                <h5>{{ popular_car.make }} {{ popular_car.model }}</h5>
                                <p class="text-muted">{{ popular_car.year }} â€¢ {{ popular_car.get_car_type_display }}</p>
                                <div class="car-stats">
                                    <div class="stat">
                                        <strong>${{ popular_car.daily_rate }}</strong>
                                        <span>Daily Rate</span>
                                    </div>
                                    <div class="stat">
                                        <strong>24</strong>
                                        <span>Bookings</span>
                                    </div>
                                    <div class="stat">
                                        <strong>92%</strong>
                                        <span>Utilization</span>
                                    </div>
                                </div>
                            </div>
                            {% else %}
                            <div class="empty-state small">
                                <i class="fas fa-car fa-2x text-muted mb-3"></i>
                                <p class="text-muted">No rental data yet</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Additional Charts -->
            <div class="row">
                <!-- Booking Trends -->
                <div class="col-lg-6 mb-4">
                    <div class="card chart-card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-chart-area me-2"></i>Booking Trends
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="bookingsChart" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Car Performance -->
                <div class="col-lg-6 mb-4">
                    <div class="card chart-card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-chart-pie me-2"></i>Car Type Distribution
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="carTypeChart" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Performance Insights -->
            <div class="row">
                <div class="col-12">
                    <div class="card insights-card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-lightbulb me-2"></i>Performance Insights
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <div class="insight-item positive">
                                        <div class="insight-icon">
                                            <i class="fas fa-trending-up"></i>
                                        </div>
                                        <div class="insight-content">
                                            <h6>Revenue Growth</h6>
                                            <p>Your monthly revenue has increased by 18% compared to last month.</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <div class="insight-item warning">
                                        <div class="insight-icon">
                                            <i class="fas fa-clock"></i>
                                        </div>
                                        <div class="insight-content">
                                            <h6>Peak Hours</h6>
                                            <p>Most bookings occur between 7-9 PM. Consider adjusting availability.</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <div class="insight-item info">
                                        <div class="insight-icon">
                                            <i class="fas fa-car"></i>
                                        </div>
                                        <div class="insight-content">
                                            <h6>Car Utilization</h6>
                                            <p>Your SUV category has the highest utilization rate at 85%.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Metric Cards */
.metric-card {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    display: flex;
    align-items: center;
    transition: var(--transition);
    border-left: 4px solid var(--primary);
    height: 100%;
}

.metric-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.12);
}

.metric-card.revenue { border-left-color: #4cc9f0; }
.metric-card.bookings { border-left-color: #f8961e; }
.metric-card.utilization { border-left-color: #7209b7; }
.metric-card.rating { border-left-color: #f72585; }

.metric-icon {
    width: 60px;
    height: 60px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 1rem;
    color: white;
    font-size: 1.5rem;
}

.metric-card.revenue .metric-icon { background: #4cc9f0; }
.metric-card.bookings .metric-icon { background: #f8961e; }
.metric-card.utilization .metric-icon { background: #7209b7; }
.metric-card.rating .metric-icon { background: #f72585; }

.metric-content h3 {
    font-weight: 700;
    margin-bottom: 0.25rem;
    color: var(--dark);
    font-size: 1.5rem;
}

.metric-content p {
    color: #6c757d;
    margin-bottom: 0.5rem;
    font-size: 0.9rem;
}

.metric-change {
    font-size: 0.8rem;
    font-weight: 600;
    padding: 0.25rem 0.5rem;
    border-radius: 20px;
}

.metric-change.positive {
    background: #d1fae5;
    color: #065f46;
}

.metric-change.neutral {
    background: #e5e7eb;
    color: #374151;
}

.metric-change.negative {
    background: #fee2e2;
    color: #dc2626;
}

/* Chart Cards */
.chart-card, .popular-car-card, .insights-card {
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    border: none;
    height: 100%;
}

.chart-card .card-header {
    border-bottom: 1px solid #e9ecef;
    padding: 1.25rem 1.5rem;
}

.chart-card .card-body {
    padding: 1.5rem;
}

.chart-container {
    position: relative;
    height: 100%;
}

/* Popular Car Card */
.popular-car-card .card-body {
    padding: 2rem 1.5rem;
}

.car-image-placeholder.large {
    width: 120px;
    height: 80px;
    background: #f8f9fa;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto;
    color: #adb5bd;
    font-size: 2rem;
}

.car-stats {
    display: flex;
    justify-content: space-around;
    margin-top: 1.5rem;
    padding-top: 1.5rem;
    border-top: 1px solid #e9ecef;
}

.car-stats .stat {
    text-align: center;
}

.car-stats .stat strong {
    display: block;
    font-size: 1.1rem;
    color: var(--dark);
    margin-bottom: 0.25rem;
}

.car-stats .stat span {
    font-size: 0.8rem;
    color: #6c757d;
}

/* Insights */
.insight-item {
    display: flex;
    align-items: flex-start;
    padding: 1rem;
    border-radius: 8px;
    background: #f8f9fa;
    height: 100%;
}

.insight-item.positive {
    border-left: 4px solid var(--success);
}

.insight-item.warning {
    border-left: 4px solid var(--warning);
}

.insight-item.info {
    border-left: 4px solid var(--info);
}

.insight-icon {
    width: 40px;
    height: 40px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 1rem;
    color: white;
    flex-shrink: 0;
}

.insight-item.positive .insight-icon { background: var(--success); }
.insight-item.warning .insight-icon { background: var(--warning); }
.insight-item.info .insight-icon { background: var(--info); }

.insight-content h6 {
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: var(--dark);
}

.insight-content p {
    color: #6c757d;
    font-size: 0.9rem;
    margin-bottom: 0;
    line-height: 1.4;
}

/* Date Range Selector */
.date-range-selector {
    max-width: 200px;
    margin-left: auto;
}

/* Empty States */
.empty-state.small {
    padding: 2rem 1rem;
}

.empty-state.small i {
    margin-bottom: 1rem;
}

/* Responsive */
@media (max-width: 768px) {
    .metric-card {
        padding: 1rem;
    }
    
    .metric-icon {
        width: 50px;
        height: 50px;
        font-size: 1.25rem;
    }
    
    .car-stats {
        flex-direction: column;
        gap: 1rem;
    }
    
    .insight-item {
        flex-direction: column;
        text-align: center;
    }
    
    .insight-icon {
        margin-right: 0;
        margin-bottom: 1rem;
    }
}
</style>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Earnings Chart
    const earningsCtx = document.getElementById('earningsChart').getContext('2d');
    const earningsChart = new Chart(earningsCtx, {
        type: 'line',
        data: {
            labels: {{ months|safe }},
            datasets: [{
                label: 'Monthly Earnings',
                data: {{ earnings|safe }},
                borderColor: '#4361ee',
                backgroundColor: 'rgba(67, 97, 238, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointBackgroundColor: '#4361ee',
                pointBorderColor: '#ffffff',
                pointBorderWidth: 2,
                pointRadius: 5,
                pointHoverRadius: 7
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleFont: {
                        size: 12
                    },
                    bodyFont: {
                        size: 13
                    },
                    padding: 12,
                    cornerRadius: 8
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    },
                    ticks: {
                        callback: function(value) {
                            return '$' + value;
                        }
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });

    // Bookings Chart (Sample Data)
    const bookingsCtx = document.getElementById('bookingsChart').getContext('2d');
    const bookingsChart = new Chart(bookingsCtx, {
        type: 'bar',
        data: {
            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
            datasets: [{
                label: 'Bookings',
                data: [12, 19, 15, 22, 18, 25],
                backgroundColor: 'rgba(76, 201, 240, 0.7)',
                borderColor: 'rgba(76, 201, 240, 1)',
                borderWidth: 1,
                borderRadius: 6,
                borderSkipped: false,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });

    // Car Type Chart (Sample Data)
    const carTypeCtx = document.getElementById('carTypeChart').getContext('2d');
    const carTypeChart = new Chart(carTypeCtx, {
        type: 'doughnut',
        data: {
            labels: ['Sedan', 'SUV', 'Compact', 'Luxury', 'Sports'],
            datasets: [{
                data: [35, 25, 20, 15, 5],
                backgroundColor: [
                    '#4361ee',
                    '#4cc9f0',
                    '#f8961e',
                    '#7209b7',
                    '#f72585'
                ],
                borderWidth: 2,
                borderColor: '#ffffff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '65%',
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 20,
                        usePointStyle: true,
                        pointStyle: 'circle'
                    }
                }
            }
        }
    });

    // Time Range Selector
    const timeRangeSelect = document.getElementById('timeRange');
    timeRangeSelect.addEventListener('change', function() {
        // In a real application, this would fetch new data from the server
        console.log('Time range changed to:', this.value);
        // You would typically make an AJAX call here to update the charts
    });
});
</script>
{% endblock %}